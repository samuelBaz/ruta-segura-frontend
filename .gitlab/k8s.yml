Obtener versión:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/alpine/git:v2.30.2
  stage: build
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  script:
    - GIT_DESCRIBE=$(git describe --tags --always)
    - APP_VERSION=${GIT_DESCRIBE%%_*}
    - echo $APP_VERSION > version.txt
  artifacts:
    paths:
      - version.txt

Build:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/node:16
  stage: build
  only:
    - /test.*/
    - /sandbox.*/
    - /develop.*/
  tags:
    - kubernetes-runner
  script:
    - cp .env.k8s .env
    - export NEXT_TELEMETRY_DISABLED 1
    - npm set registry https://registry.agcs.agetic.gob.bo
    - npm set strict-ssl false
    - npm ci 
    # - cp src/common/params/index.ts.sample src/common/params/index.ts
    # - npm run generate
    - npm run build
    # - npm ci --only=production --no-optional --legacy-peer-deps
  artifacts:
    paths:
      # - .nuxt/dist/
      # - dist/
      # - node_modules/
      - .next/standalone
      - .next/static

    expire_in: 20 mins


Verificar paquetes:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/opensecurity/nodejsscan:latest
  stage: test
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  script:
    - njsscan .
  allow_failure: true
  when: manual

Ejecutar tests de integración:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/node:16-alpine
  stage: test
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  script:
    - npm test
  allow_failure: true
  when: manual

Ejecutar tests de covertura:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/node:16-alpine
  stage: test
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  script:
    - npm run test:cov
  allow_failure: true
  when: manual

Generando reporte de calidad sonarqube:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/sonarsource/sonar-scanner-cli:4.5
  stage: test
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  before_script:
    - wget $VAULT_DOMAIN/v1/$VAULT_ROOT_PATH/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME/qa --header "X-Vault-Token:$VAULT_TOKEN" -O qa.json
    - export SONARQUBE_REPO_TOKEN=$(grep -o '"SONARQUBE_REPO_TOKEN":*"[^"]*"' qa.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export SONARQUBE_REPO_URL=$(grep -o '"SONARQUBE_REPO_URL":*"[^"]*"' qa.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - wget $VAULT_DOMAIN/v1/$VAULT_ROOT_PATH/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME/app --header "X-Vault-Token:$VAULT_TOKEN" -O app.json
    - export REFRESH_TOKEN_NAME=$(grep -o '"REFRESH_TOKEN_NAME":*"[^"]*"' app.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export REFRESH_TOKEN_SECURE=$(grep -o '"REFRESH_TOKEN_SECURE":*"[^"]*"' app.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export REFRESH_TOKEN_PATH=$(grep -o '"REFRESH_TOKEN_PATH":*"[^"]*"' app.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export APP_VERSION=$(cat version.txt)
  script:
    - npm run test:cov
    - cat test-report.xml
    - sonar-scanner -Dsonar.projectKey=$CI_PROJECT_NAME -Dsonar.host.url=$SONARQUBE_REPO_URL -Dsonar.login=$SONARQUBE_REPO_TOKEN -Dsonar.projectVersion=$APP_VERSION
  allow_failure: true
  when: manual

RetireJS:
  stage: sast
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/node:16.0.0-alpine
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  variables:
    ELK_URL_RETIREJS: http://192.168.21.70:5001 # TODO: Obtener desde vault
    SCAN_RETIRE: scan_retire_$CI_COMMIT_SHORT_SHA.json
  before_script:
    - npm set registry https://registry.agcs.agetic.gob.bo
    - npm set strict-ssl false
    - npm i -g retire
    - retire -V
  script:
    - retire --colors -v --outputformat json --outputpath $SCAN_RETIRE
    - curl --data-binary @$SCAN_RETIRE -H "app_name:retire_$CI_PROJECT_NAME" -H "version_app:$CI_COMMIT_SHORT_SHA" -H "Content-Type:application/json" $ELK_URL_RETIREJS
    - retire --colors -v --severity critical --outputformat json
  artifacts:
    paths:
      - $SCAN_RETIRE
    expire_in: 1 month
  when: manual

Snyk:
  stage: sast
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/node:16.0.0-alpine
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  variables:
    SCAN_SNYK: scan_snyk_$CI_COMMIT_SHORT_SHA.json
    ELK_URL_SNYK: http://192.168.21.70:5002 # TODO: Obtener desde vault
  before_script:
    - npm set registry https://registry.agcs.agetic.gob.bo
    - npm set strict-ssl false
    - npm i -g snyk
    - snyk -v
    # TODO: Agregar SAST_SNYK_KEY en las variables del runner
    - snyk auth $SAST_SNYK_KEY
  script:
    - snyk test --quiet --json-file-output=$SCAN_SNYK || true
    - curl --data-binary @$SCAN_SNYK -H "app_name:snyk_$CI_PROJECT_NAME" -H "version_app:$CI_COMMIT_SHORT_SHA" -H "Content-Type:application/json" $ELK_URL_SNYK
  artifacts:
    paths:
      - $SCAN_SNYK
    expire_in: 1 month
  when: manual

Trivy:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/docker:19.03.12
  stage: sast
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  except:
    refs:
      - master
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    IMAGE_NAME: "$CI_PROJECT_NAME-$CI_COMMIT_SHORT_SHA"
    TRIVY_URL_VERSION: https://api.github.com/repos/aquasecurity/trivy/releases/latest
    SCAN_TRIVY: trivy-report_$CI_COMMIT_SHORT_SHA.json
    URL_ELK: http://192.168.21.70:5000 # TODO: Obtener desde vault
  services:
    - name: docker:19.03.12-dind
  before_script:
    - export TRIVY_VERSION=$(wget -qO - "$TRIVY_URL_VERSION"|grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
    - echo $TRIVY_VERSION
    - export TRIVY_URL=https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_linux-64bit.tar.gz
    - echo $TRIVY_URL
    - wget --no-verbose $TRIVY_URL -O - |tar -zxvf -
    - apk add curl
  script:
    - docker build -t $IMAGE_NAME .
    - docker images
    - ./trivy --version
    - ./trivy --exit-code 0 --cache-dir .trivycache/ --no-progress --format template --template "@contrib/gitlab.tpl" -o $SCAN_TRIVY $IMAGE_NAME
    - curl --data-binary @$SCAN_TRIVY -H "app_name:trivy_$CI_PROJECT_NAME" -H "version_app:$CI_COMMIT_SHORT_SHA" -H "Content-Type:application/json" $URL_ELK
    - ./trivy --exit-code 0 --cache-dir .trivycache/ --no-progress --severity HIGH $IMAGE_NAME
    - ./trivy --exit-code 1 --cache-dir .trivycache/ --no-progress --severity CRITICAL $IMAGE_NAME
  artifacts:
    paths:
      - $SCAN_TRIVY
  allow_failure: true
  when: manual

Generar imagen de la aplicación:
  image: hub.agcs.agetic.gob.bo/googlehub-proxy/kaniko-project/executor:v1.3.0-debug
  stage: release
  needs:
    - job: Build
      artifacts: true
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  script:
    - wget $VAULT_DOMAIN/v1/$VAULT_ROOT_PATH/$PATH_FOLDER/infrastructure/harbor --header "X-Vault-Token:$VAULT_TOKEN" -O harbor.json
    - export IR_CHART_NAME=$(grep -o '"IR_CHART_NAME":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_DOMAIN=$(grep -o '"IR_DOMAIN":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_IOP_REPO=$(grep -o '"IR_IOP_REPO":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_PASS=$(grep -o '"IR_PASS":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_USER=$(grep -o '"IR_USER":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - echo $CONFIGURE_IMAGE | base64 -d > ./configure-image-generation.sh
    - chmod +x ./configure-image-generation.sh
    - . ./configure-image-generation.sh
    - env
    - rm harbor.json
    - rm .dockerignore
    - /kaniko/executor --context . --target=$NAMESPACE --dockerfile ./dockerfile.k8s --build-arg CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA --build-arg CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME --build-arg CI_COMMIT_MESSAGE="$CI_COMMIT_MESSAGE" --destination $IR_REPO_URL:$NAMESPACE

Desplegar la aplicación:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/alpine/helm:3.1.3
  stage: deploy
  # dependencies: []
  needs:
    - job: Build
      artifacts: false
    - job: Generar imagen de la aplicación
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  script:
    - wget $VAULT_DOMAIN/v1/$VAULT_ROOT_PATH/$PATH_FOLDER/infrastructure/harbor --header "X-Vault-Token:$VAULT_TOKEN" -O harbor.json
    - export IR_CHART_NAME=$(grep -o '"IR_CHART_NAME":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_DOMAIN=$(grep -o '"IR_DOMAIN":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_IOP_REPO=$(grep -o '"IR_IOP_REPO":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_PASS=$(grep -o '"IR_PASS":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export IR_USER=$(grep -o '"IR_USER":*"[^"]*"' harbor.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - wget $VAULT_DOMAIN/v1/$VAULT_ROOT_PATH/$PATH_FOLDER/infrastructure/kubernetes --header "X-Vault-Token:$VAULT_TOKEN" -O kubernetes.json
    - export K8S_CA_DATA=$(grep -o '"K8S_CA_DATA":*"[^"]*"' kubernetes.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export K8S_SERVER_URL=$(grep -o '"K8S_SERVER_URL":*"[^"]*"' kubernetes.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - export K8S_USER_TOKEN=$(grep -o '"K8S_USER_TOKEN":*"[^"]*"' kubernetes.json | grep -o '"[^"]*"$' | sed -e 's/^"//' | sed -e 's/"$//')
    - echo $DEPLOY_CONTAINER | base64 -d > ./configure-container-deployment.sh
    - chmod +x ./configure-container-deployment.sh
    - . ./configure-container-deployment.sh
    - helm repo add --username "robot$"$IR_USER --password $IR_PASS repository $IR_CHART_REPO_URL
    - echo $IR_USER
    - echo $IR_PASS
    - echo $IR_CHART_REPO_URL
    - helm repo update
    - echo $CI_COMMIT_SHORT_SHA
    - echo $IR_CHART_NAME
    - cat values.yml
    - cat ./config.yml
    - env
    - helm upgrade -i --debug $CI_PROJECT_NAME repository/$IR_CHART_NAME --kubeconfig ./config.yml -f values.yml -n $NAMESPACE --debug --force --set gitlabCommit=$CI_COMMIT_SHORT_SHA

1. Ejecutar setup de la base de datos:
  extends: .configure_setup
  script:
    - npm ci
    - npm run setup

2. Ejecutar migraciones de la base de datos:
  extends: .configure_setup
  script:
    - npm ci
    - npm run migrations:generate inicio
    - npm run migrations:run

3. Ejecutar seeders en la base de datos:
  extends: .configure_setup
  script:
    - npm ci
    - npm run seeds:run

.configure_setup:
  image: hub.agcs.agetic.gob.bo/dockerhub-proxy/library/node:16.16-stretch-slim
  stage: setup
  only:
    - /test.*/
    - /develop.*/
    - /sandbox.*/
  tags:
    - kubernetes-runner
  before_script:
    - echo $CONFIGURE_NAMESPACES | base64 -d > ./configure-namespaces.sh
    - chmod +x ./configure-namespaces.sh
    - . ./configure-namespaces.sh
    - echo deb http://repositorio.agetic.gob.bo/os/ftp.debian.org/debian stretch main contrib > /etc/apt/sources.list
    - echo deb http://repositorio.agetic.gob.bo/os/ftp.debian.org/debian stretch-updates main contrib >> /etc/apt/sources.list
    - echo deb http://repositorio.agetic.gob.bo/os/security.debian.org/debian-security/ stretch/updates main contrib >> /etc/apt/sources.list
    - npm set registry https://registry.agcs.agetic.gob.bo
    - npm set strict-ssl false
    - apt-get update && apt-get install -y curl jq
    - npm install -g convert-json-env
    - 'curl $(echo $VAULT_DOMAIN)/v1/$VAULT_ROOT_PATH/$(echo $CI_COMMIT_REF_NAME)/$(echo $CI_PROJECT_NAME)/app --header "X-Vault-Token: $(echo $VAULT_TOKEN)" > secrets.json'
    - echo $(jq ".data" secrets.json) > values.json
    - convert-json-env values.json --out=.env
  when: manual
